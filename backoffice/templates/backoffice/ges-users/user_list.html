{% extends 'backoffice/tools/base.html' %}

{% block title %} Utilisateurs {% endblock title %}

{% block content %}

<div class="pagetitle">
    <h1>Gestion utilisateurs</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'backoffice.index' %}">Accueil</a></li>
        <li class="breadcrumb-item">RH</li>
        <li class="breadcrumb-item active">Comptes utilisateurs</li>
      </ol>
    </nav>
  </div>
<section class="section py-4">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-4">
          <h2 class="h4 fw-bold mb-0"><i class="bi bi-person-gear"></i> Comptes Utilisateurs ({{ page_obj.paginator.count }})</h2>
          <form method="get" class="d-flex ms-md-auto" style="max-width:280px">
            <input class="form-control form-control-sm me-2" type="text" name="q" value="{{ q }}" placeholder="Rechercher…">
            <button class="btn btn-sm btn-outline-primary"><i class="bi bi-search me-1"></i></button>
          </form>
          <a href="{% url 'user.create' %}" class="btn btn-success btn-sm rounded-pill">+ Nouvel utilisateur</a>
        </div>
  
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Username</th><th>Nom</th><th>Email</th><th>Actif</th><th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for u in page_obj.object_list %}
                <tr>
                  <td class="fw-semibold">{{ u.username }}</td>
                  <td>{{ u.first_name }} {{ u.last_name }}</td>
                  <td>
                    {% if u.email %}
                      <a href="mailto:{{ u.email }}">{{ u.email }}</a>
                    {% else %}
                      {# django-allauth #}
                      {% with sa=u.socialaccount_set.all|first %}
                        {% if sa and sa.extra_data.email %}
                          <a href="mailto:{{ sa.extra_data.email }}">{{ sa.extra_data.email }}</a>
                          <span class="badge bg-light text-dark ms-1">
                            <i class="bi bi-google me-1"></i>{{ sa.provider|capfirst }}
                          </span>
                        {% else %}
                          {# python-social-auth #}
                          {% with psa=u.social_auth.all|first %}
                            {% if psa and psa.extra_data.email %}
                              <a href="mailto:{{ psa.extra_data.email }}">{{ psa.extra_data.email }}</a>
                              <span class="badge bg-light text-dark ms-1">
                                {{ psa.provider|capfirst }}
                              </span>
                            {% else %}
                              <span class="text-muted">—</span>
                            {% endif %}
                          {% endwith %}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </td>
                  
                  <td>{{ u.is_active|yesno:"Oui,Non" }}</td>
                  <td class="text-end">
                    <a href="{% url 'user.edit' u.pk %}" class="btn btn-sm btn-outline-warning">Modifier</a>
                    <a href="{% url 'user.delete' u.pk %}" class="btn btn-sm btn-outline-danger">Supprimer</a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-5">Aucun utilisateur</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
  
        {% if is_paginated %}
        <nav class="mt-3" aria-label="Pagination">
          <ul class="pagination justify-content-center mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page=1">&laquo;</a></li>
              <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">&lsaquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
            {% endif %}
  
            {% for num in page_obj.paginator.page_range %}
              {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                {% if num == page_obj.number %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                  <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
              {% endif %}
            {% endfor %}
  
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">&rsaquo;</a></li>
              <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const rhLink = document.getElementById("rh-link");
      if (rhLink) {
        rhLink.classList.add("bg-primary", "text-white");   // activation visuelle
      }
    });
  </script>

  {% endblock %}