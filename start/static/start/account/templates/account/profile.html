{% extends 'start/base.html' %}
{% block title %}Profile{% endblock title %}


{% block content %}
{% load static %}
<style>
  .cardPhoto {
    position: relative;
    width: 200px;
    height: 200px;
    border: 3px solid gray;
  }

  .cardPhoto img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-container {
    display: flex;
    align-items: center;
    justify-content: left;
  }

  .profile-name {
    font-size: 1.8em;
    font-weight: bold;
  }


  .profile-photo-container {
    width: 60px;
    height: 60px;

  }

  .profile-photo {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 4px solid #216bc4;
    object-fit: cover;
  }

  .edit-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    padding: 10px;
    color: white;
    cursor: pointer;
  }

  /* Conteneur principal */
.notifications-container {
    width: 100%;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Notification */
.notification {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 15px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
}

/* Style pour hover */
.notification:hover {
    transform: scale(1.02);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
}

/* Non-lue */
.notification.unread {
    border-left: 8px solid #007bff; /* Accent pour les non-lues */
    background: linear-gradient(90deg, #e8f1ff, #ffffff);
}

/* Lue */
.notification.read {
    border-left: 8px solid #d1d1d1;
    background-color: #f7f7f7;
}

/* Contenu */
.notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding-right: 15px;
}

/* Message */
.notification-message {
    font-size: 18px;
    font-weight: 500;
    margin: 0;
    color: #333;
}

/* Lien */
.notification-link {
    font-size: 14px;
    color: #007bff;
    text-decoration: none;
}

.notification-link:hover {
    text-decoration: underline;
}

/* Bouton "Marquer comme lu" */
.mark-as-read-btn {
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s ease, transform 0.3s ease;
}

.mark-as-read-btn:hover {
    background-color: #0056b3;
    transform: scale(1.1);
}

</style>

<div class="page-wrapper" style="background-color:#f7fafc;">

  <div class="page-body animate-bottom mt-4">
    <div class="container-xl">

      <div class="profile-container">
        <div class="profile-photo-container">
          {% if user.photo %}
          <img id="" class="profile-photo" src="{{ user.photo.url }}" alt="Photo">
          {% else %}
          <img id="" class="profile-photo"
            src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="Photo">
          {% endif %}
        </div>&nbsp;&nbsp;
        <h1 class="profile-name">{{ user.first_name }} {{ user.last_name }}</h1>
      </div>

      <div class="row col-md-12 mt-3">

        <div class="col-md-12">

          {% if not user.adresse %}
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fa fa-info-circle"></i> Veuillez mettre à jours les informations de votre compte.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
          {% if messages %}
          
               {% if messages.success %}
                  <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {% for message in messages %}
                    <i class="fa fa-check"></i> {{ message }}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endif %}
                
                {% if messages.error %}
                  <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {% for message in messages %}
                    <b>X</b> {{ message }}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endif %}


              {% if form.errors %}
                <div class="alert alert-danger">
                    <ul>
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
              {% endif %}
          
            
          
          {% endif %}
          {% if request.GET.msg_error_update_password %}

          <div class="">
            <div class="alert alert-danger alert-dismissible fade show" role="alert" data-mdb-color="danger">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-circle-letter-x" width="44"
                height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="red" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="M10 8l4 8" />
                <path d="M10 16l4 -8" />
              </svg>
              {{ request.GET.msg_error_update_password }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          </div>
          {% endif %}

          <div class="card">
            <ul class="nav nav-tabs nav-fill" data-bs-toggle="tabs">
              <li class="nav-item">
                <a href="#tabs-activity-16" class="nav-link active"
                  data-bs-toggle="tab">
                 <i class="fa fa-envelope"></i> &nbsp;
                 Boîte de réception</a>
              </li>
              <li class="nav-item">
                <a href="#tabs-home-16" class="nav-link"
                  data-bs-toggle="tab"><!-- Download SVG icon from http://tabler-icons.io/i/home -->
                  <!-- Download SVG icon from http://tabler-icons.io/i/scale -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <line x1="7" y1="20" x2="17" y2="20" />
                    <path d="M6 6l6 -1l6 1" />
                    <line x1="12" y1="3" x2="12" y2="20" />
                    <path d="M9 12l-3 -6l-3 6a3 3 0 0 0 6 0" />
                    <path d="M21 12l-3 -6l-3 6a3 3 0 0 0 6 0" />
                  </svg>
                  &nbsp;&nbsp;Mes affaires</a>
              </li>

            
              <li class="nav-item">
                <a href="#tabs-profile-16" class="nav-link"
                  data-bs-toggle="tab"><!-- Download SVG icon from http://tabler-icons.io/i/user -->
                  <!-- Download SVG icon from http://tabler-icons.io/i/pencil -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
                    <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
                  </svg>
                  &nbsp;Mise à jour</a>
              </li>
            </ul>
            <div class="card-body p-5">
              <div class="tab-content">
                <div class="tab-pane show" id="tabs-home-16">
                  <div class="container-xl d-flex flex-column justify-content-center">
                    <h3>
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="4" y1="6" x2="13" y2="6"></line><line x1="4" y1="12" x2="11" y2="12"></line><line x1="4" y1="18" x2="11" y2="18"></line><polyline points="15 15 18 18 21 15"></polyline><line x1="18" y1="6" x2="18" y2="18"></line></svg>
                      Les affaires que vous suivez :
                    </h3>
                    <hr style="margin-top: -2px;">
                    
                    {% if mesAffairesSuivies %}
                      
                    <p><i class="fa fa-info-circle" ></i> Si vous ne souhaitez plus suivre une ou plusieurs affaires, cocher la case correspondante à l'affaire en questions ensuite cliquez sur <b>"Ne plus suivre"</b></p>
                    <div class="col-3 mb-3" style="float: right;">
                      <a href="#" class="btn btn-sm btn-danger" id="ne_pas_suivre_affaire"> 
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
                        Ne plus suivre</a>
                    </div>

                    {% endif %}

                    {% for i in mesAffairesSuivies %}

                    <div class="card mb-3">
                      <div class="row g-0">
                        <div class="col-auto">
                          <div class="card-body">
                            <div class="avatar avatar-md" style="background-image: url(./static/jobs/job-2.png)"><i
                                class="fa fa-suitcase"></i></div>
                          </div>
                        </div>
                        <div class="col">
                          <div class="card-body ps-0">
                            <div class="row">
                              <div class="col">
                                {% if i.affaire.demandeurs and i.affaire.defendeurs %}
                                <h3 class="mb-0"><a href="{% url 'affaires.details' i.affaire.idAffaire %}">{{i.affaire.demandeurs }} &nbsp;<span class="badge bg-secondary text-light">demandeur</span>&nbsp; <mark>c/</mark> {{ i.affaire.defendeurs }} &nbsp;<span class="badge bg-secondary text-light">defendeur</span>&nbsp;| <span class="text-info">{{ i.affaire.role.juridiction }} </span> </a></h3>
                                {% endif %}

                                {% if i.affaire.appelants and i.affaire.intimes %}
                                <h3 class="mb-0"><a href="{% url 'affaires.details' i.affaire.idAffaire %}">{{i.affaire.appelants }} &nbsp;<span class="badge bg-secondary text-light">appelant</span>&nbsp; <mark>c/</mark> {{ i.affaire.intimes }} &nbsp;<span class="badge bg-secondary text-light">intimé</span>&nbsp; | <span class="text-info">{{ i.affaire.role.juridiction }} </span></a></h3>
                                {% endif %}

                                {% if i.affaire.prevenus and i.affaire.partieCiviles %}
                                <h3 class="mb-0"><a href="{% url 'affaires.details' i.affaire.idAffaire %}">{{i.affaire.prevenus }} &nbsp;<span class="badge bg-secondary text-light">prevenu</span>&nbsp; <mark>c/</mark> {{ i.affaire.partieCiviles }} &nbsp;<span class="badge bg-secondary text-light">partie civile</span>&nbsp; | <span class="text-info">{{ i.affaire.role.juridiction }} </span></a></h3>
                                {% endif %}
                              </div>
                             
                              <div class="col-auto fs-4 text-green">
                                {% if i.affaire.created_at|date:"Y-m-d" == today %}
                                <!-- Download SVG icon from http://tabler-icons.io/i/star -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path
                                    d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                                </svg>
                                Nouveau
                                {% endif %}
                              </div>
                              <div class="col-auto">
                                <input class="form-check-input m-0 align-middle me-2 row-checkbox" type="checkbox" aria-label="Select invoice" value="{{ i.affaire.id }}">
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-md">
                                <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                  <div class="list-inline-item">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/user -->
                                    <b>Numero RG/RP :</b> {{ i.affaire.numOrdre}}/{{i.created_at|date:"Y" }}
                                  </div>
                                  <div class="list-inline-item">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/license -->

                                    <b>Objet/Detention/Mandat de Depot :</b> {{ i.affaire.objet }} {{ i.affaire.detention }} {{ i.affaire.mandatDepot }}
                                  </div>
                                  <div class="list-inline-item">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/license -->

                                    <b>Affaire au rôle du :</b> {{ i.affaire.role.dateEnreg }}
                                  </div>

                                </div>

                              </div>

                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {% empty %}

                    <div class="empty">
                      <div class="empty-img"><img
                          src="{% static 'start/assets/statics/illustrations/undraw_work_together_h63l.svg' %}"
                          height="128" alt="">
                      </div>
                      <p class="empty-title">Aucune affaire trouvée</p>
                      <p class="empty-subtitle text-muted">
                        Recevez des notifications de decisions de justice sur les affaires que vous suivez.
                      </p>
                      <div class="empty-action">
                        <a href="{% url 'role.index' %}" class="btn btn-primary">
                          <!-- Download SVG icon from http://tabler-icons.io/i/arrow-narrow-right -->
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                            <line x1="15" y1="16" x2="19" y2="12" />
                            <line x1="15" y1="8" x2="19" y2="12" />
                          </svg>
                          Aller à la page des roles
                        </a>
                      </div>
                    </div>

                    {% endfor %}

                  </div>
                </div>

                <div class="tab-pane active" id="tabs-activity-16">
                  <div class=" d-flex flex-column justify-content-center">
                    <a href="{% url 'delete_notifications' %}" class="text-danger"><i class="fa fa-trash"></i> Vider la boîte de réception</a>

                    <div id="notifications" class="notifications-container">
                      {% for notification in notifications %}
                      <div class="notification {{ notification.type }} {% if notification.is_read %}read{% else %}unread{% endif %}" id="notification-{{ notification.id }}">
                        <div class="notification-content">
                            <p class="notification-message">{{ notification.message }}</p>
                            <p class="text-muted">{{ notification.timestamp }}</p>
                            <a href="{{ notification.url }}" class="notification-link">Voir plus</a>

                        </div>
                        
                        {% if notification.is_read == True %}
                            <button class="mark-as-read-btn">✔</button>
                        {% else %}
                            <button class="btn btn-primary" onclick="markAsRead({{ notification.id }})">Marquer comme lu</button>
                        {% endif %}
                          
                    </div>
                      {% empty %}

                      <div class="empty">
                        <!-- <div class="empty-img"><img
                            src="{% static 'start/assets/statics/illustrations/undraw_work_together_h63l.svg' %}"
                            height="128" alt="">
                        </div> -->
                        <p class="empty-title"><i class="fa fa-envelope" ></i> Vous n'avez aucun message !</p>
                       
  
                      </div>

                      {% endfor %}
                  </div>
                  </div>
                </div>

                <div class="tab-pane mt-3" id="tabs-profile-16">
                  <div class="">
                    <ul class="nav nav-tabs" data-bs-toggle="tabs">
                      <li class="nav-item">
                        <a href="#tabs-home-13" class="nav-link active" data-bs-toggle="tab">Mes informations</a>
                      </li>
                      <li class="nav-item">
                        <a href="#tabs-profile-13" class="nav-link" data-bs-toggle="tab">Changer votre mot de passe</a>
                      </li>
                    </ul>
                    <div class="card-body">
                      <div class="tab-content">
                        <div class="tab-pane show active" id="tabs-home-13">

                          <form method="POST" action="{% url 'profile' %}" enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="row">
                              <div class="container mt-2 mb-4">
                                <label class="form-label">Changez votre photo</label>
                                <div class="cardPhoto">
                                  {% if user.photo %}
                                  <img id="profile-photo" src="{{ user.photo.url }}" alt="Photo">
                                  {% else %}
                                  <img id="profile-photo"
                                    src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"
                                    alt="Photo">
                                  {% endif %}
                                  <div class="edit-icon">
                                    <a href="javascript:void(0);" onclick="document.getElementById('id_photo').click();"
                                      style="color: white;" title="Importez une photo">
                                      <!-- Download SVG icon from http://tabler-icons.io/i/camera -->
                                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path
                                          d="M5 7h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2" />
                                        <circle cx="12" cy="13" r="3" />
                                      </svg>
                                    </a>
                                    <input type="file" id="id_photo" name="photo" style="display: none;"
                                      onchange="previewPhoto(event)" accept=".jpg,.png">
                                  </div>
                                </div>
                              </div>
                              <div class="row">
                                <div class="mb-3 col-4">
                                  <label class="form-label required">Prénom</label>
                                  <input type="text" class="form-control" name="{{ form.first_name.name }}"
                                    value="{{ user.first_name|default:'' }}" autocomplete="off">
                                </div>
                                <div class="mb-3 col-4">
                                  <label class="form-label required">Nom</label>
                                  <input type="text" class="form-control" name="{{ form.last_name.name }}"
                                    value="{{ user.last_name|default:'' }}" autocomplete="off">
                                </div>
                                <div class="mb-3 col-4">
                                  <label class="form-label">Nom d'utilisateur</label>
                                  <input type="text" class="form-control" name="{{ form.username.name }}"
                                    value="{{ user.username|default:'' }}" autocomplete="off">
                                </div>
                              </div>
                              <div class="row">
                                <div class="mb-3 col-6">
                                  <label class="form-label required">Email</label>
                                  <input type="email" class="form-control" name="{{ form.email.name }}"
                                    value="{{ user.email|default:'' }}" autocomplete="off">
                                </div>
                                <div class="mb-3 col-6">
                                  <label class="form-label required">Adresse</label>
                                  <input type="text" class="form-control" name="{{ form.adresse.name }}"
                                    value="{{ user.adresse|default:'' }}" autocomplete="off">
                                </div>
                              </div>
                              <div class="row">
                                <div class="mb-3 col-6">
                                  <label class="form-label required">Telephone 1</label>
                                  <input type="tel" class="form-control" name="{{ form.tel1.name }}"
                                    value="{{ user.tel1|default:'' }}" autocomplete="off">
                                </div>
                                <div class="mb-3 col-6">
                                  <label class="form-label">Telephone 2</label>
                                  <input type="tel" class="form-control" name="{{ form.tel2.name }}"
                                    value="{{ user.tel2|default:'' }}" autocomplete="off">
                                </div>
                              </div>
                              <div class="row">
                                <div class="mb-3 col-6">
                                  <label class="form-label">Profession</label>
                                  <input type="text" class="form-control" name="{{ form.profession.name }}"
                                    value="{{ user.profession|default:'' }}" autocomplete="off">
                                </div>
                                <div class="mb-3 col-6">
                                  <label class="form-label">Nationnalité</label>
                                  <input type="text" class="form-control" name="{{ form.nationnalite.name }}"
                                    value="{{ user.nationnalite|default:'' }}" autocomplete="off">
                                </div>
                              </div>

                              <div class="container mt-4">
                                <div class="d-flex justify-content-center">
                                  <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                                </div>
                              </div>
                            </div>

                          </form>
                        </div>
                        <div class="tab-pane" id="tabs-profile-13">
                          <form method="POST" action="{% url 'change_password' %}">
                            {% csrf_token %}
                            <div class="mt-4">
                              <div class="row">
                                <div class="mb-3 col-6">
                                  <label class="form-label required">Nouveau mot de passe</label>
                                  <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="mb-3 col-6">
                                  <label class="form-label required">Confirmer le mot de passe</label>
                                  <input type="password" class="form-control" name="confirm_password" required>
                                </div>
                              </div>
                              <div class="container mt-4">
                                <div class="d-flex justify-content-center">
                                  <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
                                </div>
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

</div>
<script src="{% static 'start/assets/dist/js/virtual-select.min.js' %}"></script>
<script>
  function previewPhoto(event) {
    var reader = new FileReader();
    reader.onload = function () {
      var output = document.getElementById('profile-photo');
      output.src = reader.result;
    }
    reader.readAsDataURL(event.target.files[0]);
  }

</script>

<script>
  function markAsRead(notificationId) {
      fetch(`/account/notifications/mark-as-read/${notificationId}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      }).then(response => {
          if (response.ok) {
              document.querySelector(`#notification-${notificationId}`).classList.add('read');
          }
      });
  }
</script>




{% endblock %}